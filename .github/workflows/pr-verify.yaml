name: PR Verification

on:
  pull_request:
    branches: [master]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.changes.outputs.modules }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: changes
        run: |
          CHANGED_MODULES=$(git diff --name-only origin/main...HEAD | grep "^modules/" | cut -d/ -f1-3 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules=${CHANGED_MODULES}" >> "$GITHUB_OUTPUT"
          if [ "$CHANGED_MODULES" != "[]" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

  validate-manifests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml jsonschema

      - name: Validate manifests
        run: python scripts/check_manifest.py

  semgrep:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Run Semgrep
        uses: docker://semgrep/semgrep:1.150.0
        with:
          args: semgrep scan --config .semgrep/rules.yaml --error

  build-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        if: contains(matrix.module, 'Cargo.toml') || hashFiles(format('{0}/Cargo.toml', matrix.module)) != ''
        uses: dtolnay/rust-toolchain@stable

      - name: Install CMake dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libssl-dev libmosquitto-dev

      - name: Build module
        env:
          MODULE_PATH: ${{ matrix.module }}
        run: |
          cd "$MODULE_PATH"
          if [ -f "Cargo.toml" ]; then
            cargo build --release
          elif [ -f "CMakeLists.txt" ]; then
            mkdir -p build && cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release
            make
          else
            echo "Unknown build system"
            exit 1
          fi

  verify-gate:
    runs-on: ubuntu-latest
    needs: [validate-manifests, semgrep, build-test]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.validate-manifests.result }}" != "success" ]; then
            echo "Manifest validation failed"
            exit 1
          fi
          if [ "${{ needs.semgrep.result }}" != "success" ] && [ "${{ needs.semgrep.result }}" != "skipped" ]; then
            echo "Semgrep failed"
            exit 1
          fi
          if [ "${{ needs.build-test.result }}" != "success" ] && [ "${{ needs.build-test.result }}" != "skipped" ]; then
            echo "Build test failed"
            exit 1
          fi
          echo "All checks passed"
